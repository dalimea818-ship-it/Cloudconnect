<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Cloud</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="app-layout">
        <aside class="sidebar glass-panel">
            <h2>ğŸ“ Cloud</h2>
            <nav>
                <div class="nav-item" onclick="resetToRoot()">ğŸ  Home</div>
                <div class="nav-item" onclick="toggleTheme()">ğŸŒ“ Theme</div>
                <div class="nav-item" onclick="createFolder()">ğŸ“ New Folder</div>
                <label class="nav-item">ğŸ“¤ Upload<input type="file" multiple style="display:none" onchange="handleUpload(this)"></label>
            </nav>
        </aside>
        <main class="main-stage">
            <div id="breadcrumb" style="font-size:1.5rem; font-weight:800; margin-bottom:30px; color:var(--text-main);">My Cloud</div>
            <div id="fileGrid" class="file-grid"></div>
        </main>
    </div>

    <div id="contextMenu" class="context-menu glass-panel">
        <button onclick="triggerRename()">Rename</button>
        <button onclick="triggerIconChange()">Change Icon</button>
        <button onclick="triggerDelete()" style="color:#ff453a">Delete</button>
    </div>

    <script>
        let currentFolderId = null;
        let activeId = null;

        async function loadItems() {
            const res = await fetch(`/api/items?parentId=${currentFolderId}`);
            const items = await res.json();
            const grid = document.getElementById('fileGrid');
            
            grid.innerHTML = items.map(item => {
                const isFolder = item.type === 'folder';
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name);
                const icon = item.customIcon ? `<img src="${item.customIcon}" class="main-icon">` : (isFolder ? 'ğŸ“' : 'ğŸ“„');

                return `
                <div class="file-card glass-panel">
                    <div class="more-btn" onclick="showMenu(event, '${item._id}')">â‹®</div>
                    <div class="hit-zone" onclick="${isFolder ? `MapsIn('${item._id}', '${item.name}')` : `window.open('${item.url}', '_blank')`}">
                        <div class="icon-box" style="font-size:60px; display:flex; justify-content:center;">
                            ${isImage && !isFolder ? `<img src="${item.url}" class="img-preview">` : icon}
                        </div>
                        <div class="file-name" title="${item.name}">${item.name}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function navigateIn(id, name) {
            currentFolderId = id;
            document.getElementById('breadcrumb').innerText = name;
            loadItems();
        }

        function resetToRoot() {
            currentFolderId = null;
            document.getElementById('breadcrumb').innerText = "My Cloud";
            loadItems();
        }

        function showMenu(e, id) {
            e.stopPropagation();
            activeId = id;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.top = e.pageY + 'px';
            menu.style.left = (e.pageX - 150) + 'px';
        }

        async function triggerIconChange() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = async (e) => {
                const fd = new FormData();
                fd.append('files', e.target.files[0]);
                const res = await fetch('/api/upload', { method:'POST', body:fd });
                loadItems();
            };
            input.click();
        }

        window.onclick = () => document.getElementById('contextMenu').style.display = 'none';
        loadItems();
    </script>
</body>
</html>
