<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudConnect | Dashboard</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="glass-sidebar">
        <div class="logo">CloudConnect</div>
        <nav>
            <button class="nav-item active" onclick="loadItems()">My Cloud</button>
            <button class="nav-item" onclick="document.getElementById('fileInput').click()">Upload Files</button>
            <button class="nav-item" onclick="document.getElementById('folderInput').click()">Upload Folder</button>
        </nav>
        <div class="user-info">
            <a href="/api/logout" class="logout-link">Log Out</a>
        </div>
    </div>

    <main class="main-content">
        <header class="top-bar">
            <div id="breadcrumb">Root</div>
            <div class="search-bar">
                <input type="text" placeholder="Search your files...">
            </div>
        </header>

        <div id="file-grid" class="file-grid">
            </div>
    </main>

    <input type="file" id="fileInput" multiple style="display:none" onchange="handleUpload(this.files)">
    <input type="file" id="folderInput" webkitdirectory style="display:none" onchange="handleUpload(this.files)">

    <div id="iconPickerModal" class="modal-overlay" style="display:none;">
        <div class="glass-modal">
            <h2>Select Folder Style</h2>
            <div id="iconGrid" class="icon-grid">
                </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <label for="customFileIcon" class="btn-main">Select Custom Picture</label>
                <input type="file" id="customFileIcon" style="display:none" accept="image/*" onchange="handleCustomIconUpload(this)">
            </div>
        </div>
    </div>

    <script>
        let currentParentId = null;
        let selectedFolderId = null;

        const folderPresets = [
            "https://i.ibb.co/image_89b042.png",
            "https://i.ibb.co/image_89b07a.png",
            "https://i.ibb.co/image_89b09d.png",
            "https://i.ibb.co/image_89b366.png"
        ];

        async function loadItems() {
            const res = await fetch(`/api/items?parentId=${currentParentId}`);
            const items = await res.json();
            const grid = document.getElementById('file-grid');
            grid.innerHTML = '';

            items.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';
                // Show custom icon for folders, generic icon for files
                const iconSrc = item.type === 'folder' ? (item.customIcon || folderPresets[0]) : 'https://cdn-icons-png.flaticon.com/512/2965/2965335.png';
                
                div.innerHTML = `
                    <img src="${iconSrc}" class="item-icon">
                    <span class="item-name">${item.name}</span>
                    ${item.type === 'folder' ? `<button class="edit-icon-btn" onclick="openPicker('${item._id}')">⚙️</button>` : ''}
                `;
                
                if(item.type === 'folder') {
                    div.ondblclick = () => { currentParentId = item._id; loadItems(); };
                } else {
                    div.onclick = () => window.open(item.url, '_blank');
                }
                grid.appendChild(div);
            });
        }

        async function handleUpload(files) {
            const formData = new FormData();
            for (let f of files) formData.append('files', f);
            if(currentParentId) formData.append('parentId', currentParentId);

            await fetch('/api/upload', { method: 'POST', body: formData });
            loadItems();
        }

        function openPicker(id) {
            selectedFolderId = id;
            const modal = document.getElementById('iconPickerModal');
            const grid = document.getElementById('iconGrid');
            grid.innerHTML = '';
            
            folderPresets.forEach(url => {
                const img = document.createElement('img');
                img.src = url;
                img.onclick = () => updateIcon(url);
                grid.appendChild(img);
            });
            modal.style.display = 'flex';
        }

        async function updateIcon(url) {
            await fetch(`/api/items/${selectedFolderId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ customIcon: url })
            });
            closeModal();
            loadItems();
        }

        async function handleCustomIconUpload(input) {
            // Logic to upload a custom image to Cloudinary and set as icon
            const formData = new FormData();
            formData.append('files', input.files[0]);
            const res = await fetch('/api/upload', { method: 'POST', body: formData });
            const data = await res.json();
            // Assuming the server returns the new file object
            updateIcon(data[0].url);
        }

        function closeModal() { document.getElementById('iconPickerModal').style.display = 'none'; }

        window.onload = loadItems;
    </script>
</body>
</html>
