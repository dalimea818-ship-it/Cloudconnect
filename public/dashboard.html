<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | CloudConnect</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="app-layout">
        <aside class="sidebar glass-panel">
            <h2 style="letter-spacing:-1px;">ğŸ“ Cloud</h2>
            <nav>
                <div class="nav-item" onclick="resetToRoot()"> Home</div>
                <div class="nav-item" onclick="createNewFolder()">â• New Folder</div>
                <label class="nav-item">
                    ğŸ“¤ Upload Files
                    <input type="file" id="fileInput" multiple style="display:none" onchange="handleUpload(this)">
                </label>
                <div class="nav-item" style="margin-top:auto; color:#ff453a;" onclick="logout()">Logout</div>
            </nav>
        </aside>

        <main class="main-stage">
            <header class="dashboard-header">
                <div id="breadcrumb" class="breadcrumb">My Cloud</div>
            </header>
            
            <div id="fileGrid" class="file-grid">
                </div>
        </main>
    </div>

    <div id="contextMenu" class="context-menu glass-panel">
        <button onclick="triggerRename()">Rename</button>
        <button onclick="triggerIconChange()">Change Icon</button>
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.1); margin:5px 0;">
        <button onclick="triggerDelete()" style="color:#ff453a">Delete</button>
    </div>

    <script>
        let currentFolderId = null;
        let activeItemId = null;

        async function loadItems() {
            const res = await fetch(`/api/items?parentId=${currentFolderId}`);
            const items = await res.json();
            const grid = document.getElementById('fileGrid');
            
            grid.innerHTML = items.map(item => {
                const isFolder = item.type === 'folder';
                const isImage = /\.(jpg|jpeg|png|gif|webp)$/i.test(item.name);
                
                // Use custom icon if exists, else folder icon, else file icon
                let displayIcon = isFolder ? 'ğŸ“' : 'ğŸ“„';
                if (item.customIcon) displayIcon = `<img src="${item.customIcon}" class="main-icon">`;

                return `
                <div class="file-card glass-panel">
                    <div class="more-btn" onclick="showMenu(event, '${item._id}')">â‹®</div>
                    <div class="hit-zone" onclick="${isFolder ? `MapsIn('${item._id}', '${item.name}')` : `window.open('${item.url}', '_blank')`}">
                        <div class="icon-box">
                            ${isImage && !isFolder ? `<img src="${item.url}" class="img-preview">` : `<span style="font-size:50px;">${displayIcon}</span>`}
                        </div>
                        <div class="file-name" title="${item.name}">${item.name}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function navigateIn(id, name) {
            currentFolderId = id;
            document.getElementById('breadcrumb').innerText = name;
            loadItems();
        }

        function resetToRoot() {
            currentFolderId = null;
            document.getElementById('breadcrumb').innerText = "My Cloud";
            loadItems();
        }

        function showMenu(e, id) {
            e.preventDefault();
            e.stopPropagation();
            activeItemId = id;
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'block';
            menu.style.top = `${e.pageY}px`;
            menu.style.left = `${e.pageX - 160}px`;
        }

        async function handleUpload(input) {
            const formData = new FormData();
            for (let file of input.files) formData.append('files', file);
            formData.append('parentId', currentFolderId);

            await fetch('/api/upload', { method: 'POST', body: formData });
            loadItems();
        }

        function logout() {
            window.location.href = '/login';
        }

        window.onclick = () => document.getElementById('contextMenu').style.display = 'none';
        
        // Initial load
        loadItems();
    </script>
</body>
</html>
