<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CloudConnect</title>
<link rel="stylesheet" href="dashboard.css">
</head>
<body>

<div class="app">

    <!-- Top Glass Bar -->
    <header class="topbar glass">
        <div class="logo">‚òÅ CloudConnect</div>
        <div class="top-actions">
            <button class="logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <!-- File Area -->
    <main class="content">
        <div id="fileGrid" class="file-grid"></div>
    </main>

    <!-- Floating + Button -->
    <div class="fab-container">
        <button class="fab" onclick="toggleMenu()">+</button>
        <div id="fabMenu" class="fab-menu glass">
            <div onclick="triggerUpload()">Upload Files</div>
            <div onclick="openFolderModal()">Create Folder</div>
        </div>
    </div>

    <!-- Hidden Multi File Input -->
    <input type="file" id="fileInput" multiple hidden>

    <!-- Folder Modal -->
    <div id="folderModal" class="modal">
        <div class="modal-content glass">
            <h3>Create Folder</h3>
            <input type="text" id="folderName" placeholder="Folder name">
            <div class="modal-actions">
                <button onclick="createFolder()">Create</button>
                <button onclick="closeFolderModal()">Cancel</button>
            </div>
        </div>
    </div>

</div>

<script>

/* ---------------- LOAD FILES ---------------- */

async function loadFiles() {
    const grid = document.getElementById('fileGrid');
    grid.innerHTML = "<p class='loading'>Loading...</p>";

    try {
        const res = await fetch('/api/files');
        const files = await res.json();

        if (files.length === 0) {
            grid.innerHTML = "<p class='empty'>Your cloud is empty</p>";
            return;
        }

        grid.innerHTML = files.map(file => {
            const isImage = /\.(jpg|jpeg|png|webp|gif|svg)$/i.test(file.name);

            return `
                <div class="file-card glass">
                    <div class="preview" onclick="window.open('${file.url}','_blank')">
                        ${isImage ? `<img src="${file.url}">` : `<div class="file-icon">üìÑ</div>`}
                    </div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-actions">
                        <a href="${file.url}" target="_blank">Open</a>
                        <button onclick="deleteFile('${file._id}')">Delete</button>
                    </div>
                </div>
            `;
        }).join('');

    } catch {
        grid.innerHTML = "<p class='error'>Connection error</p>";
    }
}

/* ---------------- MULTI FILE UPLOAD ---------------- */

function triggerUpload() {
    document.getElementById('fileInput').click();
}

document.getElementById('fileInput').addEventListener('change', async function() {
    const files = this.files;
    if (!files.length) return;

    for (let file of files) {
        const formData = new FormData();
        formData.append('file', file);
        await fetch('/api/upload', {
            method: 'POST',
            body: formData
        });
    }

    loadFiles();
});

/* ---------------- DELETE ---------------- */

async function deleteFile(id) {
    if (confirm("Delete this file?")) {
        await fetch(`/api/files/${id}`, { method: 'DELETE' });
        loadFiles();
    }
}

/* ---------------- FAB MENU ---------------- */

function toggleMenu() {
    document.getElementById('fabMenu').classList.toggle('show');
}

/* ---------------- FOLDER MODAL ---------------- */

function openFolderModal() {
    document.getElementById('folderModal').style.display = 'flex';
}

function closeFolderModal() {
    document.getElementById('folderModal').style.display = 'none';
}

function createFolder() {
    const name = document.getElementById('folderName').value;
    if (!name) return alert("Enter folder name");
    alert("Folder UI ready ‚Äî backend folder support needed next.");
    closeFolderModal();
}

/* ---------------- LOGOUT ---------------- */

function logout() {
    window.location.href = "/";
}

loadFiles();

</script>
</body>
</html>