<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CloudConnect - Files</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="header">
        <h1>CloudConnect</h1>
        <button class="btn btn-delete" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <div id="breadcrumb" style="margin-bottom: 20px; font-weight: bold;">
            <span onclick="navigateTo(null)" style="cursor:pointer; color:var(--primary-color)">üè† Root</span>
        </div>

        <div class="upload-section">
            <button class="btn btn-upload" onclick="createFolder()">+ New Folder</button>
            <input type="file" id="fileInput">
            <button class="btn btn-upload" onclick="uploadFile()">Upload File</button>
            <p id="uploadStatus"></p>
        </div>

        <div id="fileGrid"></div>
    </div>

    <script>
        let currentFolderId = null;

        async function loadItems() {
            const grid = document.getElementById('fileGrid');
            grid.innerHTML = '<p>Loading...</p>';
            
            const response = await fetch(`/api/items?parentId=${currentFolderId}`);
            const items = await response.json();
            
            grid.innerHTML = items.map(item => {
                const isFolder = item.type === 'folder';
                const isImage = /\.(jpg|jpeg|png|webp)$/i.test(item.name);
                
                return `
                    <div class="file-card">
                        <div onclick="${isFolder ? `MapsTo('${item._id}', '${item.name}')` : `window.open('${item.url}', '_blank')`}" style="cursor:pointer">
                            ${isFolder ? `<span class="file-icon">üìÇ</span>` : 
                                (isImage ? `<img src="${item.url}" class="img-preview" style="width:100%; height:120px; object-fit:cover; border-radius:8px;">` : `<span class="file-icon">üìÑ</span>`)
                            }
                            <div class="file-name">${item.name}</div>
                        </div>
                        <div class="button-group">
                            ${!isFolder ? `<a href="${item.url}" target="_blank" class="btn btn-download">Download</a>` : ''}
                            <button onclick="deleteItem('${item._id}')" class="btn btn-delete">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function navigateTo(id, name) {
            currentFolderId = id;
            const bc = document.getElementById('breadcrumb');
            if (!id) {
                bc.innerHTML = '<span onclick="navigateTo(null)" style="cursor:pointer; color:var(--primary-color)">üè† Root</span>';
            } else {
                bc.innerHTML += ` > <span>${name}</span>`;
            }
            loadItems();
        }

        async function createFolder() {
            const name = prompt("Folder Name:");
            if (!name) return;
            await fetch('/api/folder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, parentId: currentFolderId })
            });
            loadItems();
        }

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const formData = new FormData();
            formData.append('file', fileInput.files[0]);
            formData.append('parentId', currentFolderId);

            document.getElementById('uploadStatus').innerText = "Uploading...";
            const response = await fetch('/api/upload', { method: 'POST', body: formData });
            if (response.ok) {
                fileInput.value = '';
                document.getElementById('uploadStatus').innerText = "";
                loadItems();
            }
        }

        async function deleteItem(id) {
            if (confirm("Delete this?")) {
                await fetch(`/api/items/${id}`, { method: 'DELETE' });
                loadItems();
            }
        }

        function logout() { window.location.href = '/'; }
        loadItems();
    </script>
</body>
</html>
