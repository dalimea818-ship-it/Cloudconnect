<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liquid Cloud</title>
    <link rel="stylesheet" href="dashboard.css">
</head>
<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <div class="app-layout">
        <aside class="sidebar glass-panel">
            <h2 style="letter-spacing: -1px; margin-bottom: 40px;">CloudConnect</h2>
            <nav style="display: flex; flex-direction: column; gap: 10px;">
                <button class="pill-btn" onclick="resetToRoot()">My Clouded Files </button>
                <button style="background:none; border:none; color:white; text-align:left; padding:12px; cursor:pointer;" onclick="createFolder()">ğŸ“‚ New Folder</button>
                <label style="padding:12px; cursor:pointer;">ğŸ“¤ Upload 
                    <input type="file" multiple style="display:none" onchange="handleUpload(this)">
                </label>
            </nav>
            <div style="margin-top:auto">
                <a href="/api/logout" style="color:rgba(255,255,255,0.5); text-decoration:none; font-size:14px;">Sign Out</a>
            </div>
        </aside>

        <main class="main-stage">
            <header style="margin-bottom: 30px;">
                <div id="breadcrumb" style="font-size: 1.2rem; font-weight: 700;">My Cloud</div>
            </header>
            
            <div id="fileGrid" class="file-grid"></div>
        </main>
    </div>

    <nav class="bottom-nav glass-panel">
        <div onclick="resetToRoot()" style="font-size:24px;">ğŸ </div>
        <div onclick="createFolder()" style="font-size:24px;">ğŸ“</div>
        <label style="font-size:32px; background:var(--accent); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;">+
            <input type="file" multiple style="display:none" onchange="handleUpload(this)">
        </label>
        <div onclick="goBack()" style="font-size:24px;">ğŸ”™</div>
        <div onclick="window.location.href='/api/logout'" style="font-size:24px;">ğŸšª</div>
    </nav>

    <script>
        let currentFolderId = null;
        let stack = [];

        async function loadItems() {
            const res = await fetch(`/api/items?parentId=${currentFolderId}`);
            const items = await res.json();
            const grid = document.getElementById('fileGrid');
            
            grid.innerHTML = items.map(item => `
                <div class="file-card glass-panel">
                    <div onclick="${item.type === 'folder' ? `MapsIn('${item._id}', '${item.name}')` : `window.open('${item.url}', '_blank')`}" style="cursor:pointer">
                        <div style="font-size:3.5rem; margin-bottom:15px;">
                            ${item.type === 'folder' ? 'ğŸ“‚' : (/\.(jpg|jpeg|png|gif)$/i.test(item.name) ? `<img src="${item.url}" style="width:100%; aspect-ratio:1; object-fit:cover; border-radius:18px;">` : 'ğŸ“„')}
                        </div>
                        <div style="font-weight:600; font-size:0.9rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.name}</div>
                    </div>
                    <button onclick="deleteItem('${item._id}')" style="background:none; border:none; color:rgba(255,255,255,0.3); font-size:10px; margin-top:15px; cursor:pointer;">Remove</button>
                </div>
            `).join('');
        }

        function navigateIn(id, name) {
            stack.push({ id: currentFolderId, name: name });
            currentFolderId = id;
            document.getElementById('breadcrumb').innerText = name;
            loadItems();
        }

        function goBack() {
            if (stack.length === 0) return;
            const prev = stack.pop();
            currentFolderId = prev.id;
            document.getElementById('breadcrumb').innerText = stack.length > 0 ? stack[stack.length-1].name : "My Cloud";
            loadItems();
        }

        function resetToRoot() {
            currentFolderId = null; stack = [];
            document.getElementById('breadcrumb').innerText = "My Cloud";
            loadItems();
        }

        async function handleUpload(input) {
            const fd = new FormData();
            for(let f of input.files) fd.append('files', f);
            fd.append('parentId', currentFolderId);
            await fetch('/api/upload', { method: 'POST', body: fd });
            loadItems();
        }

        async function createFolder() {
            const name = prompt("New Folder Name:");
            if(!name) return;
            await fetch('/api/folder', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, parentId:currentFolderId})});
            loadItems();
        }

        async function deleteItem(id) {
            if(confirm("Permanently delete?")) {
                await fetch(`/api/items/${id}`, {method:'DELETE'});
                loadItems();
            }
        }

        loadItems();
    </script>
</body>
</html>
