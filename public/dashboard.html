<!DOCTYPE html>  <html lang="en">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>CloudConnect - My Private Dashboard</title>  
    <link rel="stylesheet" href="dashboard.css">  
</head>  
<body>  <div class="header">  
    <h1>CloudConnect</h1>  
    <div class="user-controls">  
        <button class="btn btn-delete" onclick="logout()">Logout</button>  
    </div>  
</div>  

<div class="container">  
    <div class="upload-section">  
        <h3>Upload a Private File</h3>  
        <div class="file-input-wrapper">  
            <input type="file" id="fileInput">  
        </div>  
        <button class="btn btn-upload" onclick="uploadFile()">Upload to My Cloud</button>  
        <p id="uploadStatus"></p>  
    </div>  

    <div id="fileGrid">  
        </div>  
</div>  

<script>  
    // 1. Load ONLY this user's files from the server  
    async function loadFiles() {  
        const grid = document.getElementById('fileGrid');  
        grid.innerHTML = '<p>Loading your private files...</p>';  
          
        try {  
            const response = await fetch('/api/files');  
            const files = await response.json();  
              
            if (files.length === 0) {  
                grid.innerHTML = '<p>Your cloud is empty. Upload something!</p>';  
                return;  
            }  

            grid.innerHTML = files.map(file => {  
                // Logic to check if the file is an image for the preview feature  
                const isImage = /\.(jpg|jpeg|png|webp|gif|svg)$/i.test(file.name);  
                  
                return `  
                    <div class="file-card">  
                        <div onclick="window.open('${file.url}', '_blank')" style="cursor:pointer">  
                            ${isImage ?   
                                `<img src="${file.url}" class="img-preview" style="width:100%; height:120px; object-fit:cover; border-radius:8px; margin-bottom:10px;">` :   
                                `<span class="file-icon">ðŸ“„</span>`  
                            }  
                            <div class="file-name">${file.name}</div>  
                        </div>  
                        <div class="button-group">  
                            <a href="${file.url}" target="_blank" class="btn btn-download">Download</a>  
                            <button onclick="deleteFile('${file._id}')" class="btn btn-delete">Delete</button>  
                        </div>  
                    </div>  
                `;  
            }).join('');  
        } catch (err) {  
            grid.innerHTML = '<p style="color:red;">Error connecting to your cloud.</p>';  
        }  
    }  

    // 2. Upload file and tag it to the current user session  
    async function uploadFile() {  
        const fileInput = document.getElementById('fileInput');  
        const status = document.getElementById('uploadStatus');  
          
        if (fileInput.files.length === 0) {  
            alert("Please select a file first!");  
            return;  
        }  

        const formData = new FormData();  
        formData.append('file', fileInput.files[0]);  
        status.innerText = "Securing and uploading...";  

        try {  
            const response = await fetch('/api/upload', {  
                method: 'POST',  
                body: formData  
            });  

            const result = await response.json();  

            if (result.success) {  
                status.innerText = "Upload successful!";  
                fileInput.value = '';   
                loadFiles();   
            } else {  
                status.innerText = "Upload failed. Please try again.";  
            }  
        } catch (err) {  
            status.innerText = "Error uploading file.";  
        }  
    }  

    // 3. Delete file from this user's account  
    async function deleteFile(id) {  
        if (confirm("Permanently delete this file?")) {  
            try {  
                const response = await fetch(`/api/files/${id}`, {  
                    method: 'DELETE'  
                });  

                if (response.ok) {  
                    loadFiles();  
                } else {  
                    alert("Delete failed.");  
                }  
            } catch (err) {  
                alert("Error deleting file.");  
            }  
        }  
    }  

    // 4. Logout (Redirects to home)  
    function logout() {  
        window.location.href = '/';  
    }  

    // Initial Load  
    loadFiles();  
</script>

</body>  
</html>